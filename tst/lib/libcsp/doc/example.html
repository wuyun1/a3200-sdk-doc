

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Client and server example &mdash; A3200 SDK v0.6 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="A3200 SDK v0.6 documentation" href="../../../../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../../../doc/index.html" class="fa fa-home"> A3200 SDK</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../doc/a3200-full.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/a3200-full.html#a3200-sdk-main-modules">A3200 SDK Main modules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/libasf/doc/libasf.html">GomSpace ASF Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libasf/doc/libasf.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libasf/doc/libasf.html#structure">Structure</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/liba3200/doc/liba3200.html">GomSpace A3200 Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/liba3200/doc/liba3200.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/liba3200/doc/liba3200.html#a3200-board">A3200 board</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/liba3200/doc/liba3200.html#structure">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/liba3200/doc/liba3200.html#a3200-board-parameters">A3200 Board Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/liba3200/doc/liba3200.html#drivers-and-api">Drivers and API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/libcsp/doc/libcsp.html">CubeSat Space Protocol</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libcsp/README.html">The Cubesat Space Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libcsp/doc/history.html">History</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libcsp/doc/structure.html">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libcsp/doc/interfaces.html">CSP Interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libcsp/doc/memory.html">How CSP uses memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libcsp/doc/protocolstack.html">The Protocol Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libcsp/doc/topology.html">Network Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libcsp/doc/mtu.html">Maximum Transfer Unit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libcsp/doc/example.html">Client and server example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/libutil/doc/libutil.html">GomSpace Util Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libutil/doc/libutil.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libutil/doc/libutil.html#structure">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libutil/doc/libutil.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/libparam/doc/libparam.html">GomSpace Parameter Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libparam/doc/libparam.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libparam/doc/libparam.html#system-overview">System overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libparam/doc/libparam.html#gosh-local-parameter-interface">GOSH: Local parameter interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libparam/doc/libparam.html#gosh-remote-parameter-client">GOSH: Remote parameter client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libparam/doc/libparam.html#network-api">Network API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libparam/doc/libparam.html#structure">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libparam/doc/libparam.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/libgosh/doc/libgosh.html">GOSH - GomSpace Shell Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libgosh/doc/libgosh.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libgosh/doc/libgosh.html#structure">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libgosh/doc/libgosh.html#console">Console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libgosh/doc/libgosh.html#command-parser">Command Parser</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libgosh/doc/libgosh.html#defining-new-commands">Defining new commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libgosh/doc/libgosh.html#linker-optimizations">Linker-optimizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libgosh/doc/libgosh.html#implementing-a-handler-function">Implementing a handler function</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libgosh/doc/libgosh.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/libgssb/doc/libgssb.html">GomSpace Sensor Bus Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libgssb/doc/libgssb.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libgssb/doc/libgssb.html#structure">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libgssb/doc/libgssb.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/liblog/doc/liblog.html">GomSpace Log Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/liblog/doc/client-cmd.html">Client Commands</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/libstorage/doc/libstorage.html">GomSpace Storage Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libstorage/doc/libstorage.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libstorage/doc/libstorage.html#structure">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libstorage/doc/libstorage.html#implementation">Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libstorage/doc/libstorage.html#gosh-commands">GOSH Commands</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lib/libftp/doc/libftp.html">GomSpace FTP Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libftp/doc/libftp.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libftp/doc/libftp.html#structure">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib/libftp/doc/libftp.html#gosh-commands">GOSH Commands</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../doc/index.html">A3200 SDK</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../doc/index.html">Docs</a> &raquo;</li>
      
    <li>Client and server example</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../../../_sources/tst/lib/libcsp/doc/example.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="client-and-server-example">
<h1>Client and server example<a class="headerlink" href="#client-and-server-example" title="Permalink to this headline">¶</a></h1>
<p>The following examples show the initialization of the protocol stack and examples of client/server code.</p>
<div class="section" id="initialization-sequence">
<h2>Initialization Sequence<a class="headerlink" href="#initialization-sequence" title="Permalink to this headline">¶</a></h2>
<p>This code initializes the CSP buffer system, device drivers and router core. The example uses the CAN interface function csp_can_tx but the initialization is similar for other interfaces. The loopback interface does not require any explicit initialization.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#include &lt;csp/csp.h&gt;</span>
<span class="cp">#include &lt;csp/interfaces/csp_if_can.h&gt;</span>

<span class="cm">/* CAN configuration struct for SocketCAN interface &quot;can0&quot; */</span>
<span class="k">struct</span> <span class="n">csp_can_config</span> <span class="n">can_conf</span> <span class="o">=</span> <span class="p">{.</span><span class="n">ifc</span> <span class="o">=</span> <span class="s">&quot;can0&quot;</span><span class="p">};</span>

<span class="cm">/* Init buffer system with 10 packets of maximum 320 bytes each */</span>
<span class="n">csp_buffer_init</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">320</span><span class="p">);</span>

<span class="cm">/* Init CSP with address 1 */</span>
<span class="n">csp_init</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="cm">/* Init the CAN interface with hardware filtering */</span>
<span class="n">csp_can_init</span><span class="p">(</span><span class="n">CSP_CAN_MASKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">can_conf</span><span class="p">)</span>

<span class="cm">/* Setup default route to CAN interface */</span>
<span class="n">csp_route_set</span><span class="p">(</span><span class="n">CSP_DEFAULT_ROUTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csp_can_tx</span><span class="p">,</span> <span class="n">CSP_HOST_MAC</span><span class="p">);</span>

<span class="cm">/* Start router task with 500 word stack, OS task priority 1 */</span>
<span class="n">csp_route_start_task</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="server">
<h2>Server<a class="headerlink" href="#server" title="Permalink to this headline">¶</a></h2>
<p>This example shows how to create a server task that listens for incoming connections. CSP should be initialized before starting this task. Note the use of <cite>csp_service_handler()</cite> as the default branch in the port switch case. The service handler will automatically reply to ICMP-like requests, such as pings and buffer status requests.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">csp_task</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Create socket without any socket options */</span>
    <span class="kt">csp_socket_t</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">csp_socket</span><span class="p">(</span><span class="n">CSP_SO_NONE</span><span class="p">);</span>

    <span class="cm">/* Bind all ports to socket */</span>
    <span class="n">csp_bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">CSP_ANY</span><span class="p">);</span>

    <span class="cm">/* Create 10 connections backlog queue */</span>
    <span class="n">csp_listen</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

    <span class="cm">/* Pointer to current connection and packet */</span>
    <span class="kt">csp_conn_t</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
    <span class="kt">csp_packet_t</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

    <span class="cm">/* Process incoming connections */</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Wait for connection, 10000 ms timeout */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">conn</span> <span class="o">=</span> <span class="n">csp_accept</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="cm">/* Read packets. Timout is 1000 ms */</span>
        <span class="k">while</span> <span class="p">((</span><span class="n">packet</span> <span class="o">=</span> <span class="n">csp_read</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">csp_conn_dport</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nl">MY_PORT</span><span class="p">:</span>
                    <span class="cm">/* Process packet here */</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="cm">/* Let the service handler reply pings, buffer use, etc. */</span>
                    <span class="n">csp_service_handler</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/* Close current connection, and handle next */</span>
        <span class="n">csp_close</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="client">
<h2>Client<a class="headerlink" href="#client" title="Permalink to this headline">¶</a></h2>
<p>This example shows how to allocate a packet buffer, connect to another host and send the packet. CSP should be initialized before calling this function. RDP, XTEA, HMAC and CRC checksums can be enabled per connection, by setting the connection option to a bitwise OR of any combination of <cite>CSP_O_RDP</cite>, <cite>CSP_O_XTEA</cite>, <cite>CSP_O_HMAC</cite> and <cite>CSP_O_CRC</cite>.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">send_packet</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/* Get packet buffer for data */</span>
    <span class="kt">csp_packet_t</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">csp_buffer_get</span><span class="p">(</span><span class="n">data_size</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Could not get buffer element */</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to get buffer element</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Connect to host HOST, port PORT with regular UDP-like protocol and 1000 ms timeout */</span>
    <span class="kt">csp_conn_t</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">csp_connect</span><span class="p">(</span><span class="n">CSP_PRIO_NORM</span><span class="p">,</span> <span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">CSP_O_NONE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Connect failed */</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Connection failed</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">);</span>
        <span class="cm">/* Remember to free packet buffer */</span>
        <span class="n">csp_buffer_free</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Copy message to packet */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;HELLO&quot;</span><span class="p">;</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

    <span class="cm">/* Set packet length */</span>
    <span class="n">packet</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

    <span class="cm">/* Send packet */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csp_send</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* Send failed */</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Send failed</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">);</span>
        <span class="n">csp_buffer_free</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Close connection */</span>
    <span class="n">csp_close</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, GomSpace.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'v0.6',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>